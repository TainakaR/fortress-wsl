# インフラセキュリティ要塞化 実践指導書

## 1. 目的と完成条件の定義

### 1.1 実習の目的

本実習では、Webサーバー（Apache）の構築と、サーバー管理用通信（SSH）の段階的な要塞化（ハードニング）を行います。

実際に手を動かしながら、以下のインフラセキュリティの基本を体感し、理解することを目的としています。

* **アクセス制御:** ファイアウォール（UFW）を用いて、必要な通信だけを許可し、不要な通信を遮断する。
* **権限の分離:** 管理者と一般ユーザーの権限の違いを理解し、重要ファイルを守る。
* **認証強化:** パスワード認証の脆弱性を体験した上で、安全な「公開鍵認証」へと移行する。

### 1.2 完成条件（ゴール）

本実習が完了したとみなすための「判定可能な条件」は以下の3点です。最後にこれらすべてを満たしているかを確認します。

1. **Webサービスの正常稼働（公開アクセスの確認）**
* ホスト（Windows等）のブラウザから `http://localhost/health.html` にアクセスした際、画面に `OK` と表示されること。


2. **管理者によるセキュアなログイン（認証強化の確認）**
* 管理者ユーザー（自分）が、SSH鍵認証を用いて**パスワードを入力せずに**ログインできること。


3. **不正なログイン試行の完全遮断（要塞化の確認）**
* 意図的に作成したテスト用一般ユーザー（`guestuser`）が、正しいパスワードを知っていても、SSHでのログインを**即座に拒否（Permission denied）されること**。


## 2. 全体構成図とポート設計

本実習における、外部（Windowsホスト）から内部（Ubuntu/WSL2）への通信経路およびコンポーネントの関係は以下の通りです。

### 2.1 コンポーネント関係

* **外部（クライアント）**: Windowsホスト（Webブラウザ、SSHクライアント）
* **境界（ファイアウォール）**: UFW（Uncomplicated Firewall）
* **内部（サーバー）**: Ubuntu / WSL2環境
* **Webサーバー**: Apache2
* **SSHサーバー**: OpenSSH



### 2.2 ポート設計と通信経路

外部から内部へのアクセスを許可する通信経路と使用ポートを以下に定義します。

| 通信経路 | 使用ポート / プロトコル | 対象コンポーネント | 用途 | 認証方式 |
| --- | --- | --- | --- | --- |
| 外部 → 内部 | `80 / TCP` | Apache2 | Webサイトの公開・閲覧 | なし（全体公開） |
| 外部 → 内部 | `22 / TCP` | OpenSSH | サーバーの遠隔管理 | SSH公開鍵認証 |

※上記で定義したポート（80, 22）以外の外部からの着信通信は、ファイアウォール（UFW）によってすべて遮断（Deny）する設計とします。


## 3. 事前準備

本実習を確実に行うため、既存環境の簡易リセット、パッケージの更新、テスト用ユーザーの作成、およびネットワークの基本防御（ファイアウォール）の準備を行います。

### 3.1 既存環境の簡易リセット（クリーンアップ）

過去の設定が本実習に干渉しないよう、関連する設定やユーザーを一旦削除し、クリーンな状態に戻します。
*(※新規インストール環境で実行した場合、「見つからない」等のエラーが出ますが無視して進行してください)*

```bash
# テスト用ユーザーの削除
sudo deluser --remove-home guestuser

# 関連パッケージ（Apache, UFW）の完全削除
sudo apt purge apache2 ufw -y
sudo apt autoremove -y

# SSHサーバーの再インストール（設定の初期化）
sudo apt install --reinstall openssh-server -y

```

### 3.2 パッケージの更新

システムのパッケージリストを最新化し、アップグレードを行います。

```bash
sudo apt update && sudo apt upgrade -y

```

### 3.3 テスト用ユーザーの作成

パスワード認証の脆弱性確認および、権限分離のテスト対象となる一般ユーザー（`guestuser`）を作成します。

```bash
sudo adduser guestuser
# プロンプトに従い、任意のパスワード（例: password123）を設定します。
# 氏名や電話番号などの追加情報は、すべて Enter キーでスキップして構いません。

```

### 3.4 SSH鍵認証の準備（Windows側）

管理者（自分）が鍵認証でログインするための準備です。WindowsのPowerShellで公開鍵・秘密鍵のペアを作成します。*(※既に作成済みの場合はこの手順をスキップしてください)*

```powershell
# WindowsのPowerShellで実行
ssh-keygen -t ed25519

```

※後述の構築手順にて、ここで生成された公開鍵（`id_ed25519.pub`）の情報をUbuntuサーバー側に登録します。

### 3.5 基本的なファイアウォール設定（UFW）

サーバーを保護するため、ポート設計に基づいた通信制限（アクセス制御）を事前に行います。

```bash
# UFWのインストール
sudo apt install ufw -y

# デフォルトルールの設定（外部からのアクセスをすべて拒否）
sudo ufw default deny incoming

# 許可ルールの追加（Web:80, SSH:22）
sudo ufw allow 80/tcp
sudo ufw allow 22/tcp

# UFWの有効化（"Command may disrupt existing ssh connections." と出たら 'y' を入力）
sudo ufw enable

```

---

いかがでしょうか。
この手順を踏むことで、誰もが「同じスタートライン」から実習を始められるようになります。

問題なければ、次は**「4. 構築手順（コマンドは1行ごとに役割を説明）」**のパートを作成いたします！

