# インフラセキュリティ要塞化 実践指導書

## 1. 目的と完成条件の定義

### 1.1 実習の目的

本実習では、Webサーバー（Apache）の構築と、サーバー管理用通信（SSH）の段階的な要塞化（ハードニング）を行います。

実際に手を動かしながら、以下のインフラセキュリティの基本を体感し、理解することを目的としています。

* **アクセス制御:** ファイアウォール（UFW）を用いて、必要な通信だけを許可し、不要な通信を遮断する。
* **権限の分離:** 管理者と一般ユーザーの権限の違いを理解し、重要ファイルを守る。
* **認証強化:** パスワード認証の脆弱性を体験した上で、安全な「公開鍵認証」へと移行する。

### 1.2 完成条件（ゴール）

本実習が完了したとみなすための「判定可能な条件」は以下の3点です。最後にこれらすべてを満たしているかを確認します。

1. **Webサービスの正常稼働（公開アクセスの確認）**
* ホスト（Windows等）のブラウザから `http://localhost/health.html` にアクセスした際、画面に `OK` と表示されること。


2. **管理者によるセキュアなログイン（認証強化の確認）**
* 管理者ユーザー（自分）が、SSH鍵認証を用いて**パスワードを入力せずに**ログインできること。


3. **不正なログイン試行の完全遮断（要塞化の確認）**
* 意図的に作成したテスト用一般ユーザー（`guestuser`）が、正しいパスワードを知っていても、SSHでのログインを**即座に拒否（Permission denied）されること**。


## 2. 全体構成図とポート設計

本実習における、外部（Windowsホスト）から内部（Ubuntu/WSL2）への通信経路およびコンポーネントの関係は以下の通りです。

### 2.1 コンポーネント関係

* **外部（クライアント）**: Windowsホスト（Webブラウザ、SSHクライアント）
* **境界（ファイアウォール）**: UFW（Uncomplicated Firewall）
* **内部（サーバー）**: Ubuntu / WSL2環境
* **Webサーバー**: Apache2
* **SSHサーバー**: OpenSSH



### 2.2 ポート設計と通信経路

外部から内部へのアクセスを許可する通信経路と使用ポートを以下に定義します。

| 通信経路 | 使用ポート / プロトコル | 対象コンポーネント | 用途 | 認証方式 |
| --- | --- | --- | --- | --- |
| 外部 → 内部 | `80 / TCP` | Apache2 | Webサイトの公開・閲覧 | なし（全体公開） |
| 外部 → 内部 | `22 / TCP` | OpenSSH | サーバーの遠隔管理 | SSH公開鍵認証 |

※上記で定義したポート（80, 22）以外の外部からの着信通信は、ファイアウォール（UFW）によってすべて遮断（Deny）する設計とします。


## 3. 事前準備

本実習を確実に行うため、既存環境の簡易リセット、パッケージの更新、テスト用ユーザーの作成、およびネットワークの基本防御（ファイアウォール）の準備を行います。

### 3.1 既存環境の簡易リセット（クリーンアップ）

過去の設定が本実習に干渉しないよう、関連する設定やユーザーを一旦削除し、クリーンな状態に戻します。
*(※新規インストール環境で実行した場合、「見つからない」等のエラーが出ますが無視して進行してください)*

```bash
# テスト用ユーザーの削除
sudo deluser --remove-home guestuser

# 関連パッケージ（Apache, UFW）の完全削除
sudo apt purge apache2 ufw -y
sudo apt autoremove -y

# SSHサーバーの再インストール（設定の初期化）
sudo apt install --reinstall openssh-server -y

```

### 3.2 パッケージの更新

システムのパッケージリストを最新化し、アップグレードを行います。

```bash
sudo apt update && sudo apt upgrade -y

```

### 3.3 テスト用ユーザーの作成

パスワード認証の脆弱性確認および、権限分離のテスト対象となる一般ユーザー（`guestuser`）を作成します。

```bash
sudo adduser guestuser
# プロンプトに従い、任意のパスワード（例: password123）を設定します。
# 氏名や電話番号などの追加情報は、すべて Enter キーでスキップして構いません。

```


### 3.4 管理者用（あなた用）のSSH鍵認証の準備

次に、管理者（あなた自身）が安全にサーバー（Ubuntu）へログインするための「専用の鍵」を作成します。
この作業は、Ubuntuの中ではなく、外側にある**WindowsのPowerShell**で行います。*(※すでに鍵を作成済みの場合はこの手順をスキップしてください)*

```powershell
# Windows側のPowerShellを起動し、以下のコマンドを実行します
ssh-keygen -t ed25519

```

コマンドを実行すると、作成先やパスワードに関する質問（プロンプト）が英語で3回表示されます。本実習では**すべて何も入力せずに「Enterキー」を押して進めてください。**

* **1回目の質問（保存場所の確認）:**
`Enter file in which to save the key (...):`
⇒ **そのまま Enter を押します。**（カッコ内に表示されている標準の保存場所が自動的に選択されます）
* **2回目・3回目の質問（パスワードの設定）:**
`Enter passphrase (empty for no passphrase):`
`Enter same passphrase again:`
⇒ 本実習では鍵そのものへのパスワード設定は不要とするため、**何も入力せずに Enter を2回**押します。

**【作成されるファイルについて】**
画面に図形（Randomart image）が表示されれば完了です。Windowsの `C:\Users\あなたのユーザー名\.ssh\` フォルダ内に、以下のペアとなる2つのファイルが作成されます。

1. **`id_ed25519`（秘密鍵）**

2. **`id_ed25519.pub`（公開鍵）**


### 3.5 基本的なファイアウォール設定（UFW）

サーバーを保護するため、ポート設計に基づいた通信制限（アクセス制御）を事前に行います。

```bash
# UFWのインストール
sudo apt install ufw -y

# デフォルトルールの設定（外部からのアクセスをすべて拒否）
sudo ufw default deny incoming
# 「Default incoming policy changed to 'deny'」と表示されれば成功

# 許可ルールの追加（Web:80, SSH:22）
sudo ufw allow 80/tcp
sudo ufw allow 22/tcp

# UFWの有効化（"Command may disrupt existing ssh connections." と出たら 'y' を入力）
sudo ufw enable

```



## 4. 構築手順

本章では、Webサーバーの立ち上げと、管理者（あなた自身）が安全にログインするための「公開鍵」の設置を行います。ここからのコマンドは、特記がない限り **Ubuntuのターミナル** で実行してください。

### 4.1 Webサーバー（Apache）の構築とヘルスチェック用ページの作成

Webページを公開するためのソフトウェア（Apache）をインストールし、動作確認用の簡単なページを作成します。

```bash
# Apache2（Webサーバーソフト）をインストールします（-y は確認画面をスキップするオプション）
sudo apt install apache2 -y

# "OK"という文字が書かれた health.html というファイルを、Web公開用フォルダに作成します
echo "OK" | sudo tee /var/www/html/health.html

```

* **`sudo`**: 管理者権限でコマンドを実行するためのおまじないです。システムに関わる変更には必須です。
* **`apt install`**: Ubuntuに新しいソフトウェア（パッケージ）を追加するコマンドです。
* **`echo` と `tee`**: `echo` で出力した文字を、`tee` を使って管理者権限が必要な場所（`/var/www/html/`）のファイルに書き込んでいます。

### 4.2 管理者用（あなた用）のSSH公開鍵の登録と権限設定

事前準備（3.4）でWindows側に作成した「公開鍵」を、Ubuntu側のあなたのホームディレクトリに設置し、厳重に保管します。

#### ① 鍵を置くための専用フォルダを作成・権限設定する

```bash
# あなたのホームディレクトリに「.ssh」という隠しフォルダを作成します（-p は既に存在していてもエラーにしないオプション）
mkdir -p ~/.ssh

# 作成した .ssh フォルダのアクセス権限を「所有者（自分）のみ読み書き実行可能（700）」に変更します
chmod 700 ~/.ssh

```

#### ② Windowsから公開鍵をコピーしてUbuntuに貼り付ける

ここで、WindowsとUbuntuを行き来します。間違えて「秘密鍵（拡張子なし）」を扱わないよう注意してください。

**1. Windows側での操作:**

**WindowsのPowerShell**で以下のコマンドを実行し、公開鍵の中身を画面に表示させます。

```powershell
# ※「あなたのユーザー名」はWindowsのユーザー名に置き換えてください
cat C:\Users\あなたのユーザー名\.ssh\id_ed25519.pub

```

画面に表示された `ssh-ed25519 AAAA...` から末尾まで続く**1行の文字列をすべてコピー**します。

**2. Ubuntu側での操作:**
Ubuntuのターミナルに戻り、以下のコマンドで鍵を登録するファイルを作成・編集します。

```bash
# コマンドライン用のテキストエディタ（nano）を開き、authorized_keys というファイルを作成します
nano ~/.ssh/authorized_keys
# 本手順では nano の操作方法を解説します
```

エディタが開いたら、**先ほどコピーした公開鍵を貼り付けます**（ターミナル上で右クリックすると貼り付けられます）。
貼り付けたら、以下のキーボード操作で保存して閉じます。

1. `Ctrl + O` （保存の準備）
2. `Enter` （ファイル名の決定）
3. `Ctrl + X` （エディタの終了）

#### ③ 鍵ファイルの権限を厳格に設定する

鍵ファイルは、他の誰かに書き換えられたり覗き見られたりすると致命的なため、厳しく制限をかけます。

```bash
# authorized_keys ファイルのアクセス権限を「所有者（自分）のみ読み書き可能（600）」に変更します
chmod 600 ~/.ssh/authorized_keys

```

* **`chmod 700` と `chmod 600` の重要性**:
他のユーザー（今回作成した `guestuser` など）がこのフォルダに侵入したり、勝手に自分の鍵を登録したりできないようにする重要なセキュリティ設定です。この権限設定が甘いと、SSHサーバー自体が「危険な状態だ」と判断し、安全のため鍵の利用を拒否してしまいます。


### 4.3 Fail2ban（不正アクセス自動遮断ツール）の導入

パスワード認証を無効化しても、悪意のあるプログラムは延々とログインを試み、サーバーに無駄な負荷をかけ続けます。そこで、一定回数アクセスに失敗したIPアドレスを自動的にブロック（BAN）するツール「Fail2ban」を導入し、多層防御を完成させます。

#### ① Fail2banのインストール

```bash
# Fail2banパッケージをインストールします
sudo apt install fail2ban -y

```

#### ② 設定ファイルの準備（ベストプラクティス）

Fail2banには最初から `jail.conf` という設定ファイルが用意されていますが、これを直接編集することは避けます（ソフトウェアのアップデート時に上書きされて設定が消えてしまうためです）。
代わりに、コピーを作成してそちらを利用します。

```bash
# デフォルトの設定ファイル(jail.conf)をコピーし、編集用のファイル(jail.local)を作成します
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local

```

* **`cp`**: ファイルをコピー（Copy）するコマンドです。
* **`/etc/fail2ban/jail.conf`**: コピー元のファイル（オリジナルの設定）です。
* **`/etc/fail2ban/jail.local`**: コピー先のファイルです。Fail2banは、`.local` というファイルがあれば、オリジナルの `.conf` よりもそちらを優先して読み込む仕組みを持っています。


## 5. 設定ファイル（完全版）

本章では、SSHサーバーのルールブックである `sshd_config` を編集し、パスワード認証を完全に廃止します。これにより、鍵を持たない `guestuser` や外部からの攻撃者をシャットアウトします。

### 5.1 設定ファイルの基本情報と確認方法

編集作業に入る前に、このファイルがシステム上でどのように守られているか（所有権や権限）を、実際にコマンドを使って自分の目で確認してみましょう。

Ubuntuのターミナルで、以下のコマンドを実行してください。

```bash
# ls -l は、ファイルの詳細情報（権限や所有者など）をリスト表示するコマンドです
ls -l /etc/ssh/sshd_config

```

**【出力結果の見方】**
画面に `-rw-r--r-- 1 root root ... /etc/ssh/sshd_config` のような1行が表示されます。この結果から、以下の3つの重要な情報が読み取れます。

* **保存パス:** `/etc/ssh/sshd_config`
* **所有権（`root root` の部分）:**
このファイルはシステム管理者である `root`（ルート）ユーザーが所有していることを示しています。
* **権限（`-rw-r--r--` の部分）:**
これがアクセス権限（パーミッション）を表しており、数字で表すと `644` となります。
* 最初の `rw-` : 所有者（root）は「読み（Read）」「書き（Write）」が可能。
* 次の `r--` : 所属グループは「読むこと」のみ可能。
* 最後の `r--` : その他の一般ユーザー（`guestuser` など）も「読むこと」しかできない。


> **【セキュリティのポイント】**
> 出力結果から分かる通り、「その他の一般ユーザー」には書き込み権限（`w`）が与えられていません。もし誰でも書き換えられる状態だと、悪意のあるユーザーが勝手に裏口を開けてしまいます。
> だからこそ、この後このファイルを編集する際には、必ず `sudo`（一時的にrootの強い権限を借りるコマンド）を先頭につける必要があるのです。

### 5.2 設定ファイルの置き換え手順

設定時に陥りやすい「設定ファイルの書き間違い」を防ぐため、元の内容を一度すべて削除し、安全に設定された【完全版】を丸ごと貼り付けます。

**① エディタでファイルを開く**

```bash
sudo nano /etc/ssh/sshd_config

```

**② 元の内容をすべて削除する**
エディタが開いたら、キーボードの `Ctrl + K` を**押しっぱなし**にして、最初から書かれている文章を一番下まですべて消去して空っぽにします。

**③ 【完全版】設定を貼り付ける**
以下のテキストをすべてコピーし、空になったエディタに貼り付けてください（ターミナル上で右クリック）。

```text
# /etc/ssh/sshd_config - Secure Hardened Version
# =========================================================
# 本実習用に最適化されたSSHサーバー設定ファイル（完全版）
# =========================================================

# 1. 基本設定（ポート番号と待ち受け）
Include /etc/ssh/sshd_config.d/*.conf
Port 22
ListenAddress 0.0.0.0
ListenAddress ::

# 2. 認証設定（ここが要塞化の要です）
LoginGraceTime 2m
PermitRootLogin no
StrictModes yes
MaxAuthTries 6
MaxSessions 10

# 公開鍵認証を「有効(yes)」にする
PubkeyAuthentication yes

# パスワード認証を「無効(no)」にする（ブルートフォース攻撃を完全に防ぐ）
PasswordAuthentication no
PermitEmptyPasswords no

# 対話型のパスワード入力等も「無効(no)」にする
KbdInteractiveAuthentication no

# 3. その他のシステム標準設定
UsePAM yes
X11Forwarding no
PrintMotd no
AcceptEnv LANG LC_*
Subsystem sftp /usr/lib/openssh/sftp-server

```

**④ 保存して閉じる**
貼り付けが終わったら、以下の手順で保存します。

1. `Ctrl + O` を押す（保存の準備）
2. `Enter` を押す（ファイル名 `/etc/ssh/sshd_config` で上書き確定）
3. `Ctrl + X` を押す（エディタを終了して元の画面に戻る）

### 5.3 要塞化のポイント（変更点の解説）

貼り付けたファイルの中で、特に重要なセキュリティ設定は以下の3行です。

* **`PermitRootLogin no`**: 強力な `root` ユーザーでの直接ログインを禁止します。
* **`PubkeyAuthentication yes`**: あなたが先ほど登録した「公開鍵」を使ったログインを許可します。
* **`PasswordAuthentication no`**: **（超重要）** パスワードを使ったログインを一切受け付けなくします。これにより、パスワードを推測される「総当たり攻撃」が100%無効化されます。


### 5.4 Fail2ban設定ファイル（jail.local）

インストールしたFail2banに対し、「どのログを監視し、どのような条件で遮断（BAN）するか」を指定するルールブックを作成します。

#### ① 設定ファイルの基本情報

* **保存パス:** `/etc/fail2ban/jail.local`
* **所有権:** `root:root`
* **権限:** `644 (rw-r--r--)`

#### ② 設定ファイルの編集手順

**1. エディタでファイルを開く**

```bash
sudo nano /etc/fail2ban/jail.local

```

**2. 元の内容をすべて削除する**
エディタが開いたら、`Ctrl + K` を押しっぱなしにして、最初から書かれている数百行の内容をすべて消去します。

**3. 【完全版】設定を貼り付ける**
以下の内容をコピーし、空になったエディタに貼り付けてください。

```text
# /etc/fail2ban/jail.local - SSH Protection Setting
# =========================================================
# 本実習用に最適化されたFail2ban設定ファイル（完全版）
# =========================================================

[DEFAULT]
# 遮断（BAN）する時間（10分間）
bantime  = 10m

# 監視する期間（この5分間に失敗を繰り返すとBANされる）
findtime  = 5m

# 許容する失敗回数（5回失敗したらBAN）
maxretry = 5

# 遮断に使用するソフトウェア
banaction = ufw

[sshd]
# SSHの監視を有効にする
enabled = true

# 監視するポート（SSH用の22番）
port    = ssh

# 監視するログファイル（SSHのログイン履歴）
logpath = %(sshd_log)s

# 判定に使用するフィルター
backend = %(sshd_backend)s

```

**4. 保存して閉じる**

1. `Ctrl + O` （保存）
2. `Enter` （確定）
3. `Ctrl + X` （終了）

#### ③ 設定のポイント解説

* **`bantime = 10m`**: ルールに違反した相手を10分間「出入り禁止」にします。
* **`maxretry = 5`**: 5回連続でログインに失敗したIPアドレスを「攻撃者」とみなします。
* **`banaction = ufw`**: 先ほど設定した「門番（UFW）」と連携して、自動的に新しい「拒否ルール」を追記させます。
* **`[sshd] enabled = true`**: SSHサーバーに対する監視を明示的にONにしています。


## 6. サービスの起動／永続化

編集した設定ファイルをシステムに反映させ、OSが再起動しても自動的に各サービスが立ち上がるように設定します。

```bash
# Apacheの設定を反映し、OS起動時の自動起動を有効にします
sudo systemctl enable --now apache2

# SSHの設定（sshd_config）を反映し、OS起動時の自動起動を有効にします
sudo systemctl enable --now ssh

# Fail2banの設定（jail.local）を反映し、OS起動時の自動起動を有効にします
sudo systemctl enable --now fail2ban

```

* **`systemctl enable --now`**: 「今すぐ起動する（start）」と「次回OS起動時も自動で起動する（enable）」を同時に行う便利なコマンドです。
* **反映の確認**: 万が一、設定ファイルに書き間違い（タイポ）がある場合、このコマンドを実行した際に赤文字でエラーが表示されます。その場合は、第5章の設定内容を再度見直してください。

---

## 7. 動作確認と検証

最後に、第1章で定義した「完成条件」をすべて満たしているか、実際にテストを行います。

### 7.1 Webサービスの正常稼働テスト

ホスト側（Windows）のブラウザを開き、アドレスバーに以下を入力してアクセスします。

* **URL**: `http://localhost/health.html`
* **判定**: 画面に **OK** とだけ表示されれば成功です。

### 7.2 管理者の鍵認証テスト

WindowsのPowerShellを新しく開き、パスワードなしでログインできるか試します。

```powershell
# あなたのUbuntuユーザー名でログインを試行します
ssh <あなたのユーザー名>@localhost
# 質問される内容には 'yes' と答えてください

```

* **判定**: パスワードを聞かれずに、直接Ubuntuの操作画面（プロンプト）が表示されれば、**公開鍵認証による要塞化**が成功しています。

### 7.3 一般ユーザー（guestuser）の拒否テスト

わざと「鍵を持っていない一般ユーザー」でログインを試み、要塞が機能しているか確認します。

```powershell
# guestuserとしてログインを試行します
ssh guestuser@localhost

```

* **判定**: 正しいパスワードを知っていても `Permission denied (publickey)` と表示され、ログインを即座に拒否されれば成功です。これが**パスワード認証廃止**の効果です。

### 7.4 Fail2banの稼働状態テスト

Ubuntu側で、監視ツールが正しく動作しているか確認します。

```bash
# Fail2banがSSHを監視しているかステータスを表示します
sudo fail2ban-client status sshd

```

* **判定**: 出力結果の `Status for the jail: sshd` の下に、`Currently failed` や `Total failed` という項目が表示されていれば、監視が正常に行われています。


## 8. トラブルシューティング

本実習で発生しやすい代表的なエラーと、その解決策をまとめます。

### 8.1 「WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!」と出る

* **原因**: サーバーの再インストール等により、Windowsが覚えているサーバーの識別情報と現在の情報が食い違っているため。
* **対処**: WindowsのPowerShellで `ssh-keygen -R localhost` を実行し、古い情報をリセットしてください。

### 8.2 「Permission denied (publickey)」でログインできない

* **原因1**: 公開鍵（`.pub`）の内容を貼り付ける際に、改行が入ったり一部が欠けたりしている。
* **原因2**: Ubuntu側の `~/.ssh` フォルダや `authorized_keys` ファイルの権限（chmod）が正しくない。
* **対処**: 手順4.2を最初からやり直し、特に `chmod 600` 等の設定が正しく行われているか確認してください。

### 8.3 編集後にSSHの設定ミスで接続できなくなった

* **原因**: `sshd_config` の記述ミス。
* **対処**: WSL環境であれば、ターミナルから直接 `sudo nano /etc/ssh/sshd_config` を開いて修正可能です。修正後は必ず `sudo systemctl restart ssh` を忘れないでください。

---

## 9. セキュリティ配慮

本実習で行った設定には、以下のセキュリティ上の意図が含まれています。

* **権限最小化の原則**:
`guestuser` のような一般ユーザーに `sudo` 権限を与えないことで、万が一パスワードが漏洩してもシステム全体が乗っ取られるリスクを最小限に抑えています。
* **多層防御の構築**:
1. **UFW** で不要な入り口を閉じる。

2. **SSH鍵認証** でパスワード破りを防ぐ。

3. **Fail2ban** で執拗な攻撃者を自動遮断する。
このように複数の壁を作ることで、一つの防御が破られても致命的な被害を防ぎます。


* **秘密情報の扱い**:
秘密鍵（`id_ed25519`）は、決してネットワーク上に流したり、他人に共有したりしてはいけません。

---

## 10. 参考資料

本実習の内容をさらに深く理解するための公式ドキュメントです。

* **Ubuntu 公式 UFW ドキュメント**: [https://help.ubuntu.com/community/UFW](https://help.ubuntu.com/community/UFW)
* **OpenSSH 公式サイト**: [https://www.openssh.com/](https://www.openssh.com/)
* **Fail2ban プロジェクトページ**: [https://www.fail2ban.org/](https://www.fail2ban.org/)
